{% extends 'game/base.html' %}

{% block title%}Game{% endblock %}

{% block page %}Game{% endblock %} 

{% block content %} 
  <style>

    .textInputCenter{
      text-align: center;
    }

    .bottomScreenButtons{
      padding-left: 50px;
    }

    /* Code to make the button round */
    .button {
      background-color: #11f8a3; /* Green */
      border: none;
      color: white;
      padding: 100px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 4px 2px;
      cursor: pointer;
    }

    .button5 {
      border-radius: 50%;
      
    }
  </style>

  <!-- Center of screen -->
  <div class="textInputCenter">
    <button id="color_button"class="button button5" onclick="getLocation()">click here</button>
  </div>

  <!-- Javascript to change button -->
  <script>
  //document.getElementById("demo").outerHTML= "NEW TEXT";
  
  function getLocation() {
        if (navigator.geolocation) {
          //if successful, redirect to showPosition
          //if not, redirect to showError
          navigator.geolocation.getCurrentPosition(changeButtonColour, showError);
        } else {
          div.innerHTML = "The Browser Does not Support Geolocation";
        }
      }


  /*RETURNS the 'degrees' score for the player based on their distance from destination
  and the size of the playing area */
  function calcDegrees(distance, diameter) {
    if (distance > diameter) {
      return 0;
    } else {
      return 100 - ((distance / diameter) * 100);
    }

  }

  //changes the colour of the button based on the user's current GPS coordinates
  function changeButtonColour(position) {

    //TODO fetch destination coordinates from database - hardcoded to harrison building for now
    let dest_lat = 50.737220; 
    let dest_lng = -3.532380;
    
    /*This is the size of the playing area - hardcoded to 1km for uni campus for now
    Simply for possible scalability in the future */
    let game_bound = 1000;

    //calculate distance between current gps coordinates and destination coordinates
    let distance = calcDistance(position.coords.latitude,position.coords.longitude,dest_lat,dest_lng);
    //DEBUG ONLY
    //distance = 1005;    
    
    //calculate degrees score based on distance from destination
    let degrees = calcDegrees(distance, game_bound);


    //decide which colour to make the button based on the degrees score
    if (degrees < 10) {document.getElementById("color_button").style.backgroundColor='#0010ff'} else
    if (degrees < 20) {document.getElementById("color_button").style.backgroundColor='#0071ff'} else
    if (degrees < 30) {document.getElementById("color_button").style.backgroundColor='#0090ff'} else
    if (degrees < 40) {document.getElementById("color_button").style.backgroundColor='#00ffdc'} else
    if (degrees < 50) {document.getElementById("color_button").style.backgroundColor='#c4ff00'} else
    if (degrees < 60) {document.getElementById("color_button").style.backgroundColor='#ecff00'} else
    if (degrees < 70) {document.getElementById("color_button").style.backgroundColor='#ffbe00'} else
    if (degrees < 80) {document.getElementById("color_button").style.backgroundColor='#ff8000'} else
    if (degrees < 90) {document.getElementById("color_button").style.backgroundColor='#ff3e00'} else
    {document.getElementById("color_button").style.backgroundColor='#ff0000'}
  }

  //calculates the distance between 2 GPS coordinates
  function calcDistance(lat1,lng1,lat2,lng2){

    //convert coordinates to radians
    lat1 = lat1*Math.PI / 180;
    lng1 = lng1*Math.PI / 180;
    lat2 = lat2*Math.PI / 180;
    lng2 = lng2*Math.PI / 180;


    //this calculation is just nicked from the internet
    //apparently: "Distance d = 3963.0 * arccos[(sin(lat1) * sin(lat2)) + cos(lat1) * cos(lat2) * cos(long2 â€“ long1)]"
    let dlng = lng2 - lng1;
    let dlat = lat2 - lat1;
    let a = Math.pow(Math.sin(dlat / 2), 2)
            + Math.cos(lat1) * Math.cos(lat2)
            * Math.pow(Math.sin(dlng / 2),2);
          
    let c = 2 * Math.asin(Math.sqrt(a));
    let r = 6371 //radius of earth in kilometres

    //calculate result
    return Math.round((c*r)*1000);

    }

  //This is where we end up if the user clicks 'block' instead of 'accept' when the browser
  //asks to use their location
  function showError(error) {
        if(error.PERMISSION_DENIED){
            div.innerHTML = "Please allow location access in order to play the game.";
        }
  }

  
  </script>

{% endblock %}
